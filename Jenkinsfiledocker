pipeline {
   agent none
    stages {
      stage ('my build') {
        agent { node { label 'build' } }
        steps {
         sh 'echo ${BUILD_VERSION}' 
         sh 'docker build -t tomcatimage .'
        }
      }
      stage (publish) {
        agent { node { label 'build' } }
          steps {
            sh 'echo ${BUILD_VERSION}'
            sh 'docker login -u waliuddin -p Wali@8792'
            sh 'docker tag tomcatimage waliuddin/mytomcat'
            sh 'docker push waliuddin/mytomcat'
        }
      } 
    stage ('my deploy') {
      agent { node { label 'deploy' } }
       steps {
        sh 'docker pull waliuddin/mytomcat'
        sh 'docker rm -f mytomcat:latest' 
        sh 'docker run -d -p 8080:8080 --name mytomcat waliuddin/mytomcat'
      }
    } 
  }
}
